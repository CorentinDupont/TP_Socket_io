<!doctype html>
<style>
    @import url('https://fonts.googleapis.com/css?family=Quicksand');
  
    html, body{
        /* width:100%;
        min-height:100%;
        max-height:100%; */
        margin:0;
        padding:0;
        position:fixed;
        top:0;
        bottom:0;
        left:0;
        right:0;
        display:flex;
    }
  
    * {
        font-family: "Quicksand";
        box-sizing: border-box;
        min-height:0;
    }
  
    h1, h2, h3, h4, h5, p{
      margin:0;
      font-weight:normal;
    }
  
    /*-------------------------------------------------*/
    /*--------------------   MAIN    ------------------*/
    /*-------------------------------------------------*/
  
    #index-body{
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  
    header{
      width:100%;
      background-color:#C5B7FF;
      padding:20px;
      /* height:80px; */
      display:flex;
      flex-grow: 0;
      flex-shrink: 0;
      flex-basis: auto;
    }
  
    header>h1{
      font-size:20px;
      color:white;
    }
  
    #content{
      display: flex;
      flex-direction: row;
      flex-grow:1;
      width:100%;
    }
  
    #main-section{
      display: flex;
      flex-grow: 1;
    }

    .right-menu{
      width:400px;
      background-color:#F8F6FF;
      display: flex;
      flex-direction: column;
    }
  
    /*-------------------------------------------------*/
    /*---------------   MESSAGES SECTION    -----------*/
    /*-------------------------------------------------*/
  
    /*---------------   Messages styles    -----------*/
  
  
    #messages-section{
      justify-content: space-between;
    }
  
    #messages-container{
      display: flex;
      flex-direction:column;
      padding:10px;
      overflow-y: scroll;
      flex-grow:1;
    }
  
    .message{
      display:flex;
      flex-direction: column;
      margin-bottom:20px;
      flex-grow: 0;
      flex-shrink: 0;
      flex-basis: auto;
    }
  
    .message .message-author{
      font-size:12px;
      color:#959595;
      margin-bottom: 3px;
    }
  
    .message .message-body{
      max-width:250px;
      min-width:100px;
      font-size:13px;
      color:#959595;
      padding:10px;
    }
  
    .message-me .message-body{
      border-radius: 8px 8px 8px 0;
      background-color: #C5B7FF;
      color:white;
    }
  
    .message-other{
      align-self: flex-end;
      align-items: flex-end;
    }
  
    .message-other .message-body{
      border-radius: 8px 8px 0 8px;
      background-color: #F3F1FC;
      max-width:250px;
    }
  
    /*---------------   Send message part    -----------*/
  
    #message-sender{
      display:flex;
      flex-direction:row;
      border-radius:8px;
      background-color:white;
      /* border:solid #CCCCCC 1px; */
      /* width:100%; */
      margin:10px;
      overflow: hidden;
      align-items: flex-end;
      min-height: 60px;
    }
  
    #message-sender textarea{
      font-size:13px;
      color:#959595;
      border:none;
      height:100%;
      width:300px;
    }
  
    #send-message-button{
      background-color:transparent;
      font-size:13px;
      color:#C5B7FF;
      font-weight:normal;
      text-transform: uppercase;
      border:none;
      border-radius:6;
      height:20px;
    }
    #send-message-button:hover{
      font-weight:bold;
      cursor:pointer;
    }

    /*----------------- Title  -----------------*/

    #conversation-title-block{
      display: flex;
      flex-direction: row;
      padding:20px 10px 10px 10px;
      align-items:center;
      /* justify-content: space-between; */
    }

    #conversation-title{
      font-size:22px;
      margin-right:20px;
      
    }

    #message-return-button{
      background-color:#F3F1FC;
      font-size:13px;
      color:#C5B7FF;
      font-weight:normal;
      text-transform: uppercase;
      border:none;
      border-radius:8px;
      height:30px;
      min-width:100px;
      /* margin:10px; */
    }

     #message-return-button:hover{
      background-color:#EBE6FF;
      cursor:pointer;
     }

    /*-------------------------------------------------*/
    /*--------------   USER LIST SECTION    -----------*/
    /*-------------------------------------------------*/

    #user-list-section{
      padding:10px;
    }

    #user-list-section>h2{
      font-size:22px;
      margin-bottom:20px;
      margin-top:10px;
    }

    #user-list{
      
    }

    #user-list hr{
      width:80%;
      margin-top:20px;
      margin-bottom: 20px;
    }

    .user-item{
      padding:20px;
      border-radius:8px;
      background-color: #F3F1FC;
      color:#959595;
      margin-bottom:10px;
    }

    .user-item:hover{
      background-color:#EBE6FF;
      cursor:pointer;
    }

    /*------------------------------------------------*/
    /*---------- GLOBAL CLASS (HIGH PRIORITY) --------*/
    /*------------------------------------------------*/

    .hidden{
      display:none;
    }
  </style>

  <html lang="fr">

    <head>
      <meta charset="utf-8">
      <title>Morpion Online</title>
      <!-- <link rel="stylesheet" type="text/css" href="../css/main.css"> -->
    </head>

    <body id="index-body">

      <!-- Header -->
      <header>
        <h1>Morpion Online</h1>
      </header>

      <!-- All page -->
      <div id="content">

        <!-- Place for action like connect to one user, morpion game ... -->
        <section id="main-section">

        </section>

        <!-- tchat panel -->
        <section id="messages-section" class="right-menu hidden">

          <!-- conversation's title-->
          <div id="conversation-title-block">
            <p id="conversation-title">Une discussion ...</p>
            <!-- return button -->
            <button id="message-return-button" type="button">Retour</button>
          </div>
          

          <!-- All messages -->
          <div id="messages-container">
            <!-- Some content will be append here -->
          </div>

          <!-- Block with input to send message -->
          <div id="message-sender">
            <textarea id="message-textarea"></textarea>
            <button id="send-message-button" type="button">envoyer</button>
          </div>
        </section>

        <!-- connected user list -->
        <section id="user-list-section" class="right-menu">
          <h2>Discussion</h2>
          <div id="user-list">
            <div id="global-message-channel-button" class="user-item"><p>Global channel</p></div>
            <hr>
          </div>
        </section>

      </div>
      
      <script src="/socket.io/socket.io.js"></script>
      <script>
        var socket = io();

        socket.emit('loaded', 'page loaded !!!');
      
        var messageContainer = document.getElementById('messages-container');
        var sendMessageButton = document.getElementById('send-message-button');
        var messageTextArea = document.getElementById('message-textarea');
        let messageReturnButton = document.getElementById('message-return-button');
        let conversationTitle = document.getElementById('conversation-title');

        let globalMessageChannelButton = document.getElementById("global-message-channel-button");
        let messagesSection = document.getElementById("messages-section");
        let userListSection = document.getElementById("user-list-section");


        /*---------------------- MESSAGES ------------------------*/


        // sending message in channel
        sendMessageButton.addEventListener('click', () => {
          socket.emit('message', messageTextArea.value)
          messageTextArea.value = '';
        })
      
        // receive message by socket
        socket.on('message', data => {
          console.log('message received : ', data);
          messageContainer.appendChild(createMessage(data.isMe, data.message, data.socketId));
        })        

        // Global channel button

        globalMessageChannelButton.addEventListener('click', () => {
          userListSection.classList.add("hidden");
          messagesSection.classList.remove("hidden");
          conversationTitle.innerText="Global Channel"
        })

        // on click on user



        // Return button

        messageReturnButton.addEventListener('click', () => {
          messagesSection.classList.add("hidden");
          userListSection.classList.remove("hidden");
        })

        // user list

        socket.on('clients', (data) => {
          feedUserList(data);
        })

        function createMessage(isMe, message, socketId){
          let messageBlock = document.createElement("div");
          messageBlock.classList.add("message");

          isMe ? messageBlock.classList.add("message-me") : messageBlock.classList.add("message-other");

          let messageAuhtor = document.createElement("p");
          messageAuhtor.classList.add("message-author");
          messageAuhtor.innerText = isMe ? "Me" : socketId;

          let messageBody = document.createElement("p");
          messageBody.classList.add("message-body");
          messageBody.innerText = message;

          messageBlock.appendChild(messageAuhtor);
          messageBlock.appendChild(messageBody);

          return messageBlock;
        }

        function feedUserList(data){
          let userList = document.getElementById('user-list');
          data.clients.forEach(client => {
            userList.appendChild(createUserItem(data.users[client]));
          });
        }

        function createUserItem(user){
          let userItem = document.createElement("div");
          userItem.classList.add('user-item');
          userItem.setAttribute("id", user.socketId);

          userItem.addEventListener('click', () => {
            launchConversation(user);
          })

          let userName = document.createElement("p");
          userName.innerText = user.name;
          userItem.appendChild(userName);

          return userItem;
        }

        function launchConversation(user){
          userListSection.classList.add("hidden");
          messagesSection.classList.remove("hidden");
          conversationTitle.innerText=user.name;
          console.log(user);
        }
      </script>
    </body>
</html>

